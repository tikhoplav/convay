<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Convay's game of life</title>
	<link rel="stylesheet" href="/styles.css">
</head>
<body>
	<canvas id='main'></canvas>
	<script type="module">
		import Rendrer from './modules/renderer.js'
		import Socket, { decode } from './modules/socket.js'

		const canvas = document.getElementById('main')
		const ctx = canvas.getContext('webgl2')
		if (!ctx) throw Error('Canvas ctx unavailable')

		const rend = Rendrer(ctx)

		let scale = 10
		let desiredScale = scale
		rend.setTransform(0, 0, scale)
		document.addEventListener('wheel', ({ deltaY }) => {
			const x = scale * (1 - Math.sign(deltaY) * 0.5)
			desiredScale = Math.min(Math.max(x, 1), 100)
		})

		window.onresize = () => {
			const { innerWidth: width, innerHeight: height} = window
			canvas.width = width
			canvas.height = height
			rend.resize()
		}
		window.onresize()

		const socket = Socket()

		const onFirst = async pack => {
			const [data, count] = await decode(pack)
			rend.createBuffer(data.length)
			rend.update(data, count)

			socket.onmessage = async pack => {
				const [data, count] = await decode(pack)
				rend.update(data, count)
			}

			socket.removeEventListener('message', onFirst)
		}
		socket.addEventListener('message', onFirst)

		const frame = dt => {
			if (Math.abs(scale - desiredScale) / scale > 0.01) {
				scale = scale - (scale - desiredScale) / 50
				rend.setTransform(0, 0, scale)
			}

			rend.draw()
			window.requestAnimationFrame(frame)
		}

		window.requestAnimationFrame(frame)
	</script>
</body>
</html>